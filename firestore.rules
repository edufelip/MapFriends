rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isValidHandle(handle) {
      return handle.matches('^[a-z0-9_]{3,20}$');
    }

    function isReservedHandle(handle) {
      return [
        'admin',
        'support',
        'root',
        'mapfriends',
        'official',
        'api',
        'help',
        'security',
        'billing',
        'about',
        'terms',
        'privacy',
      ].hasAny([handle]) || handle.matches('^(admin|support).*');
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function handlePath(handle) {
      return /databases/$(database)/documents/handles/$(handle);
    }

    function reviewPath(reviewId) {
      return /databases/$(database)/documents/reviews/$(reviewId);
    }

    function userReviewPath(uid, reviewId) {
      return /databases/$(database)/documents/userReviews/$(uid)/items/$(reviewId);
    }

    function userFollowingPath(uid, followedUid) {
      return /databases/$(database)/documents/userFollowing/$(uid)/items/$(followedUid);
    }

    function userFollowersPath(uid, followerUid) {
      return /databases/$(database)/documents/userFollowers/$(uid)/items/$(followerUid);
    }

    function userFollowRequestPath(uid, requesterUid) {
      return /databases/$(database)/documents/userFollowRequests/$(uid)/items/$(requesterUid);
    }

    function userPath(uid) {
      return /databases/$(database)/documents/users/$(uid);
    }

    function isProfileOpen(uid) {
      return exists(userPath(uid))
        && get(userPath(uid)).data.visibility == 'open';
    }

    function hasReviewKeys(data) {
      return data.keys().hasOnly([
        'id',
        'placeId',
        'placeTitle',
        'placeCoordinates',
        'title',
        'notes',
        'rating',
        'visibility',
        'userId',
        'userName',
        'userHandle',
        'userAvatar',
        'photos',
        'photoUrls',
        'createdAt',
        'updatedAt',
      ]);
    }

    function isValidReviewPayload(data, uid, reviewId) {
      return hasReviewKeys(data)
        && data.id == reviewId
        && data.userId == uid
        && data.placeId is string
        && data.placeTitle is string
        && (
          data.placeCoordinates == null
          || (
            data.placeCoordinates is list
            && data.placeCoordinates.size() == 2
            && data.placeCoordinates[0] is number
            && data.placeCoordinates[1] is number
          )
        )
        && data.title is string
        && data.notes is string
        && data.notes.size() > 0
        && data.notes.size() <= 400
        && data.rating is number
        && data.rating >= 1
        && data.rating <= 10
        && data.visibility in ['followers', 'subscribers']
        && data.userName is string
        && data.userHandle is string
        && (data.userAvatar == null || data.userAvatar is string)
        && data.photos is list
        && data.photoUrls is list
        && data.photos.size() <= 10
        && data.photoUrls.size() <= 10
        && data.photos.size() == data.photoUrls.size()
        && data.createdAt is string
        && data.updatedAt is string;
    }

    function docsMatch(a, b) {
      return a.id == b.id
        && a.placeId == b.placeId
        && a.placeTitle == b.placeTitle
        && a.placeCoordinates == b.placeCoordinates
        && a.title == b.title
        && a.notes == b.notes
        && a.rating == b.rating
        && a.visibility == b.visibility
        && a.userId == b.userId
        && a.userName == b.userName
        && a.userHandle == b.userHandle
        && a.userAvatar == b.userAvatar
        && a.photos == b.photos
        && a.photoUrls == b.photoUrls
        && a.createdAt == b.createdAt
        && a.updatedAt == b.updatedAt;
    }

    function handleBelongsToUserAfter(handle, uid) {
      return existsAfter(handlePath(handle))
        && getAfter(handlePath(handle)).data.uid == uid;
    }

    function isHandleImmutableOnUserWrite() {
      return resource == null || request.resource.data.handle == resource.data.handle;
    }

    match /handles/{handle} {
      allow read: if isSignedIn();
      allow create: if isOwner(request.resource.data.uid)
        && isValidHandle(handle)
        && !isReservedHandle(handle)
        && request.resource.data.keys().hasOnly(['uid', 'createdAt'])
        && !exists(handlePath(handle));
      allow update: if false;
      allow delete: if isSignedIn() && resource.data.uid == request.auth.uid;
    }

    match /users/{uid} {
      allow read: if isOwner(uid);
      allow create, update: if isOwner(uid)
        && request.resource.data.uid == uid
        && isValidHandle(request.resource.data.handle)
        && !isReservedHandle(request.resource.data.handle)
        && isHandleImmutableOnUserWrite()
        && handleBelongsToUserAfter(request.resource.data.handle, uid);
      allow delete: if isOwner(uid);
    }

    match /userMeta/{uid} {
      allow read: if isOwner(uid);
      allow create, update: if isOwner(uid)
        && request.resource.data.uid == uid
        && request.resource.data.keys().hasOnly([
          'uid',
          'hasAcceptedTerms',
          'hasCompletedProfile',
          'hasCompletedOnboarding',
          'onboardingVersion',
          'updatedAt',
        ])
        && request.resource.data.hasAcceptedTerms is bool
        && request.resource.data.hasCompletedProfile is bool
        && request.resource.data.hasCompletedOnboarding is bool
        && request.resource.data.onboardingVersion is int;
      allow delete: if isOwner(uid);
    }

    match /reviews/{reviewId} {
      allow read: if isSignedIn();
      allow create, update: if isSignedIn()
        && isValidReviewPayload(request.resource.data, request.auth.uid, reviewId)
        && (resource == null || (
          request.resource.data.userId == resource.data.userId
          && request.resource.data.createdAt == resource.data.createdAt
        ))
        && existsAfter(userReviewPath(request.auth.uid, reviewId))
        && docsMatch(
          request.resource.data,
          getAfter(userReviewPath(request.auth.uid, reviewId)).data
        );
      allow delete: if isSignedIn()
        && resource.data.userId == request.auth.uid
        && !existsAfter(userReviewPath(request.auth.uid, reviewId));
    }

    match /userReviews/{uid}/items/{reviewId} {
      allow read: if isOwner(uid);
      allow create, update: if isOwner(uid)
        && isValidReviewPayload(request.resource.data, uid, reviewId)
        && existsAfter(reviewPath(reviewId))
        && docsMatch(
          request.resource.data,
          getAfter(reviewPath(reviewId)).data
        );
      allow delete: if isOwner(uid)
        && !existsAfter(reviewPath(reviewId));
    }

    match /userFavorites/{uid}/items/{reviewId} {
      allow read: if isOwner(uid);
      allow create, update: if isOwner(uid)
        && request.resource.data.keys().hasOnly([
          'userId',
          'reviewId',
          'createdAt',
          'snapshot',
        ])
        && request.resource.data.userId == uid
        && request.resource.data.reviewId == reviewId
        && request.resource.data.createdAt is string
        && request.resource.data.snapshot is map
        && request.resource.data.snapshot.keys().hasOnly([
          'placeId',
          'placeTitle',
          'reviewTitle',
          'reviewNotes',
          'reviewRating',
          'reviewPhotoUrl',
          'reviewAuthorId',
          'reviewAuthorName',
          'reviewAuthorHandle',
          'reviewAuthorAvatar',
        ])
        && request.resource.data.snapshot.placeId is string
        && request.resource.data.snapshot.placeTitle is string
        && request.resource.data.snapshot.reviewTitle is string
        && request.resource.data.snapshot.reviewNotes is string
        && request.resource.data.snapshot.reviewRating is number
        && (request.resource.data.snapshot.reviewPhotoUrl == null || request.resource.data.snapshot.reviewPhotoUrl is string)
        && request.resource.data.snapshot.reviewAuthorId is string
        && request.resource.data.snapshot.reviewAuthorName is string
        && request.resource.data.snapshot.reviewAuthorHandle is string
        && (request.resource.data.snapshot.reviewAuthorAvatar == null || request.resource.data.snapshot.reviewAuthorAvatar is string);
      allow delete: if isOwner(uid);
    }


    match /userFollowing/{uid}/items/{followedUid} {
      allow read: if isOwner(uid);
      allow create, update: if isSignedIn()
        && (
          (
            isOwner(uid)
            && isProfileOpen(followedUid)
          )
          || (
            request.auth.uid == followedUid
            && exists(userFollowRequestPath(followedUid, uid))
          )
        )
        && request.resource.data.keys().hasOnly([
          'userId',
          'followedUserId',
          'createdAt',
        ])
        && request.resource.data.userId == uid
        && request.resource.data.followedUserId == followedUid
        && request.resource.data.createdAt is string;
      allow delete: if isOwner(uid);
    }

    match /userFollowers/{uid}/items/{followerUid} {
      allow read: if isOwner(uid);
      allow create, update: if isSignedIn()
        && existsAfter(userFollowingPath(followerUid, uid))
        && (
          (
            request.auth.uid == followerUid
            && isProfileOpen(uid)
          )
          || (
            isOwner(uid)
            && exists(userFollowRequestPath(uid, followerUid))
          )
        )
        && request.resource.data.keys().hasOnly([
          'userId',
          'followerUserId',
          'createdAt',
        ])
        && request.resource.data.userId == uid
        && request.resource.data.followerUserId == followerUid
        && request.resource.data.createdAt is string;
      allow delete: if isSignedIn()
        && (isOwner(uid) || request.auth.uid == followerUid);
    }

    match /userFollowRequests/{uid}/items/{requesterUid} {
      allow read: if isOwner(uid) || (isSignedIn() && request.auth.uid == requesterUid);
      allow create, update: if isSignedIn()
        && request.auth.uid == requesterUid
        && request.resource.data.keys().hasOnly([
          'targetUserId',
          'requesterUserId',
          'requesterName',
          'requesterHandle',
          'requesterAvatar',
          'createdAt',
        ])
        && request.resource.data.targetUserId == uid
        && request.resource.data.requesterUserId == requesterUid
        && request.resource.data.requesterName is string
        && request.resource.data.requesterHandle is string
        && (request.resource.data.requesterAvatar == null || request.resource.data.requesterAvatar is string)
        && request.resource.data.createdAt is string;
      allow delete: if isOwner(uid) || (isSignedIn() && request.auth.uid == requesterUid);
    }

    match /userNotifications/{uid}/items/{notificationId} {
      allow read: if isOwner(uid);
      allow create: if isSignedIn()
        && request.resource.data.keys().hasOnly([
          'id',
          'userId',
          'type',
          'actorUserId',
          'actorName',
          'actorHandle',
          'actorAvatar',
          'createdAt',
          'readAt',
          'requestStatus',
          'targetReviewId',
          'targetReviewPlaceTitle',
          'targetReviewPlaceSubtitle',
          'targetReviewImageUrl',
          'targetReviewVisibility',
        ])
        && request.resource.data.id == notificationId
        && request.resource.data.userId == uid
        && request.resource.data.actorUserId == request.auth.uid
        && request.resource.data.type in [
          'follow_started',
          'follow_request',
          'review_published',
          'follow_request_accepted',
        ]
        && request.resource.data.actorName is string
        && request.resource.data.actorHandle is string
        && (request.resource.data.actorAvatar == null || request.resource.data.actorAvatar is string)
        && request.resource.data.createdAt is string
        && (request.resource.data.readAt == null || request.resource.data.readAt is string)
        && request.resource.data.requestStatus in [null, 'pending', 'accepted', 'declined']
        && (request.resource.data.targetReviewId == null || request.resource.data.targetReviewId is string)
        && (request.resource.data.targetReviewPlaceTitle == null || request.resource.data.targetReviewPlaceTitle is string)
        && (request.resource.data.targetReviewPlaceSubtitle == null || request.resource.data.targetReviewPlaceSubtitle is string)
        && (request.resource.data.targetReviewImageUrl == null || request.resource.data.targetReviewImageUrl is string)
        && request.resource.data.targetReviewVisibility in [null, 'followers', 'subscribers']
        && (
          (
            request.resource.data.type == 'follow_started'
            && exists(userFollowingPath(request.auth.uid, uid))
          )
          || (
            request.resource.data.type == 'follow_request'
            && request.resource.data.requestStatus == 'pending'
            && exists(userFollowRequestPath(uid, request.auth.uid))
          )
          || (
            request.resource.data.type == 'follow_request_accepted'
            && exists(userFollowersPath(request.auth.uid, uid))
          )
          || (
            request.resource.data.type == 'review_published'
            && request.resource.data.targetReviewId is string
            && request.resource.data.targetReviewVisibility in ['followers', 'subscribers']
            && exists(userFollowersPath(request.auth.uid, uid))
          )
        );
      allow update: if isOwner(uid)
        && request.resource.data.keys().hasOnly([
          'id',
          'userId',
          'type',
          'actorUserId',
          'actorName',
          'actorHandle',
          'actorAvatar',
          'createdAt',
          'readAt',
          'requestStatus',
          'targetReviewId',
          'targetReviewPlaceTitle',
          'targetReviewPlaceSubtitle',
          'targetReviewImageUrl',
          'targetReviewVisibility',
        ])
        && request.resource.data.id == resource.data.id
        && request.resource.data.userId == resource.data.userId
        && request.resource.data.type == resource.data.type
        && request.resource.data.actorUserId == resource.data.actorUserId
        && request.resource.data.actorName == resource.data.actorName
        && request.resource.data.actorHandle == resource.data.actorHandle
        && request.resource.data.actorAvatar == resource.data.actorAvatar
        && request.resource.data.createdAt == resource.data.createdAt
        && request.resource.data.targetReviewId == resource.data.targetReviewId
        && request.resource.data.targetReviewPlaceTitle == resource.data.targetReviewPlaceTitle
        && request.resource.data.targetReviewPlaceSubtitle == resource.data.targetReviewPlaceSubtitle
        && request.resource.data.targetReviewImageUrl == resource.data.targetReviewImageUrl
        && request.resource.data.targetReviewVisibility == resource.data.targetReviewVisibility
        && (request.resource.data.readAt == null || request.resource.data.readAt is string)
        && request.resource.data.requestStatus in [null, 'pending', 'accepted', 'declined'];
      allow delete: if isOwner(uid);
    }

    match /userBlocks/{uid}/items/{blockedUid} {
      allow read: if isOwner(uid);
      allow create, update: if isOwner(uid)
        && request.resource.data.keys().hasOnly([
          'userId',
          'blockedUserId',
          'blockedName',
          'blockedHandle',
          'blockedAvatar',
          'createdAt',
        ])
        && request.resource.data.userId == uid
        && request.resource.data.blockedUserId == blockedUid
        && request.resource.data.blockedName is string
        && request.resource.data.blockedHandle is string
        && (request.resource.data.blockedAvatar == null || request.resource.data.blockedAvatar is string)
        && request.resource.data.createdAt is string;
      allow delete: if isOwner(uid);
    }

    match /reviewLikes/{reviewId}/users/{uid} {
      allow read: if isSignedIn();
      allow create, update: if isOwner(uid)
        && request.resource.data.keys().hasOnly([
          'reviewId',
          'userId',
          'createdAt',
        ])
        && request.resource.data.reviewId == reviewId
        && request.resource.data.userId == uid
        && request.resource.data.createdAt is string;
      allow delete: if isOwner(uid);
    }

    match /reviewComments/{reviewId}/items/{commentId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn()
        && request.resource.data.keys().hasOnly([
          'reviewId',
          'userId',
          'userName',
          'userHandle',
          'userAvatar',
          'text',
          'createdAt',
          'updatedAt',
        ])
        && request.resource.data.reviewId == reviewId
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.userName is string
        && request.resource.data.userHandle is string
        && (request.resource.data.userAvatar == null || request.resource.data.userAvatar is string)
        && request.resource.data.text is string
        && request.resource.data.text.size() > 0
        && request.resource.data.text.size() <= 200
        && request.resource.data.createdAt is string
        && request.resource.data.updatedAt is string;
      allow update: if false;
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }
  }
}
