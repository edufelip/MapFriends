name: Android Firebase Distribution

on:
  workflow_dispatch: {}
  push:
    branches: [develop]
    paths-ignore:
      - "supabase/**"
      - "docs/**"
      - "web/**"
  pull_request:
    branches:
      - develop
      - release/**
      - hotfix/**
    paths-ignore:
      - "supabase/**"
      - "docs/**"
      - "web/**"

jobs:
  firebase-distribution:
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    env:
      ORG_GRADLE_PROJECT_newArchEnabled: false
    defaults:
      run:
        working-directory: android

    steps:
      - uses: actions/checkout@v4

      - name: Write env files
        run: |
          cat <<'ENVEOF' > .env.development
          ${{ secrets.ENV_FILE_DEV }}
          ENVEOF
          cp .env.development .env
        working-directory: .

      - name: Export env vars
        run: |
          while IFS= read -r line; do
            case "$line" in
              ''|\#*) continue ;;
              EXPO_PUBLIC_*=*) echo "$line" >> "$GITHUB_ENV" ;;
            esac
          done < <(sed -e 's/\r$//' .env.development)
        working-directory: .

      - name: Set debug API flag
        run: |
          echo "EXPO_PUBLIC_USE_DEV_API=true" >> "$GITHUB_ENV"
        working-directory: .

      - name: Set Expo environment
        run: |
          echo "APP_ENV=dev" >> "$GITHUB_ENV"
          echo "APP_VARIANT=dev" >> "$GITHUB_ENV"
          echo "EXPO_PUBLIC_APP_ENV=dev" >> "$GITHUB_ENV"
          echo "EXPO_PUBLIC_APP_VARIANT=dev" >> "$GITHUB_ENV"
          echo "NODE_ENV=development" >> "$GITHUB_ENV"
        working-directory: .

      - name: Validate Expo environment
        run: |
          if [ "$APP_ENV" != "dev" ]; then
            echo "APP_ENV must be 'dev' (got '$APP_ENV')" >&2
            exit 1
          fi
          echo "APP_ENV=$APP_ENV"
          echo "EXPO_PUBLIC_APP_ENV=$EXPO_PUBLIC_APP_ENV"
        working-directory: .

      - name: Validate Firebase and Mapbox secrets
        env:
          GOOGLE_SERVICES_JSON_BASE64: ${{ secrets.GOOGLE_SERVICES_JSON_BASE64_DEV }}
          FIREBASE_APP_ID_ANDROID: ${{ secrets.FIREBASE_APP_ID_ANDROID_DEV }}
          FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
          MAPBOX_DOWNLOADS_TOKEN: ${{ secrets.MAPBOX_DOWNLOADS_TOKEN }}
        run: |
          if [ -z "$GOOGLE_SERVICES_JSON_BASE64" ]; then
            echo "GOOGLE_SERVICES_JSON_BASE64_DEV is not set" >&2
            exit 1
          fi
          if [ -z "$FIREBASE_APP_ID_ANDROID" ]; then
            echo "FIREBASE_APP_ID_ANDROID_DEV is not set" >&2
            exit 1
          fi
          if [ -z "$FIREBASE_SERVICE_ACCOUNT_JSON" ]; then
            echo "FIREBASE_SERVICE_ACCOUNT_JSON is not set" >&2
            exit 1
          fi
          if [ -z "$MAPBOX_DOWNLOADS_TOKEN" ]; then
            echo "MAPBOX_DOWNLOADS_TOKEN is not set" >&2
            exit 1
          fi
        working-directory: .

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install JS deps
        run: npm ci
        working-directory: .

      - name: Ensure Android native project exists
        run: |
          if [ ! -d android ] || [ ! -f android/gradlew ]; then
            npx expo prebuild --platform android --non-interactive --no-install
          fi
        working-directory: .

      - name: Configure Mapbox Maven auth
        env:
          MAPBOX_DOWNLOADS_TOKEN: ${{ secrets.MAPBOX_DOWNLOADS_TOKEN }}
        run: bash scripts/ci/ensure_mapbox_maven_android.sh
        working-directory: .

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set CI version code
        run: echo "CI_VERSION_CODE=${{ github.run_number }}" >> "$GITHUB_ENV"

      - name: Write google-services.json
        run: |
          mkdir -p app
          echo "${{ secrets.GOOGLE_SERVICES_JSON_BASE64_DEV }}" | base64 -d > app/google-services.json

      - name: Build dev debug APK
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: wrapper
          build-root-directory: android
          arguments: |
            clean
            assembleDebug
            -PCI_VERSION_CODE=${{ env.CI_VERSION_CODE }}

      - name: Release notes
        run: |
          NOTES=$(git log -1 --pretty=%B)
          echo "RELEASE_NOTES<<EOF" >> "$GITHUB_ENV"
          echo "$NOTES" >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"
        working-directory: .

      - name: Write Firebase service account
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}' > firebase-service-account.json
        working-directory: .

      - name: Preflight Firebase App Distribution access
        id: firebase_preflight
        env:
          GOOGLE_APPLICATION_CREDENTIALS: firebase-service-account.json
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID_ANDROID_DEV }}
          EXPECTED_ANDROID_PACKAGE: com.edufelip.mapfriends.dev
        run: |
          set -euo pipefail

          FIREBASE_PROJECT_ID="$(node -e "const fs=require('fs');const key=JSON.parse(fs.readFileSync('firebase-service-account.json','utf8'));process.stdout.write(key.project_id||'')")"
          FIREBASE_SERVICE_ACCOUNT_EMAIL="$(node -e "const fs=require('fs');const key=JSON.parse(fs.readFileSync('firebase-service-account.json','utf8'));process.stdout.write(key.client_email||'')")"

          if [ -z "$FIREBASE_PROJECT_ID" ]; then
            echo "Unable to read project_id from FIREBASE_SERVICE_ACCOUNT_JSON." >&2
            exit 1
          fi

          if [ -z "${FIREBASE_APP_ID:-}" ]; then
            echo "FIREBASE_APP_ID_ANDROID_DEV is empty." >&2
            exit 1
          fi

          echo "[firebase-ci] service_account_email=$FIREBASE_SERVICE_ACCOUNT_EMAIL"
          echo "[firebase-ci] service_account_project_id=$FIREBASE_PROJECT_ID"
          echo "[firebase-ci] firebase_app_id_android_dev=$FIREBASE_APP_ID"

          if [[ ! "$FIREBASE_APP_ID" =~ ^1:[0-9]+:android:[a-f0-9]+$ ]]; then
            echo "FIREBASE_APP_ID_ANDROID_DEV does not look like an Android Firebase App ID (expected 1:<project-number>:android:<hash>)." >&2
            exit 1
          fi

          if ! npm_config_loglevel=error npx --yes firebase-tools@latest appdistribution:groups:list \
            --project "$FIREBASE_PROJECT_ID" \
            --json >/tmp/fad-groups.json 2>/tmp/fad-groups.err; then
            echo "Firebase App Distribution authorization failed for project $FIREBASE_PROJECT_ID." >&2
            cat /tmp/fad-groups.err >&2 || true
            echo "Grant roles/firebaseappdistro.admin (or roles/firebase.admin) to $FIREBASE_SERVICE_ACCOUNT_EMAIL on project $FIREBASE_PROJECT_ID." >&2
            exit 1
          fi

          if ! npm_config_loglevel=error npx --yes firebase-tools@latest apps:list \
            --project "$FIREBASE_PROJECT_ID" \
            --json >/tmp/fad-apps.json 2>/tmp/fad-apps.err; then
            echo "Unable to list Firebase apps for project $FIREBASE_PROJECT_ID." >&2
            cat /tmp/fad-apps.err >&2 || true
            exit 1
          fi

          EXPECTED_FIREBASE_APP_ID="$(jq -r --arg pkg "$EXPECTED_ANDROID_PACKAGE" '.result[]? | select((.platform == "ANDROID" or .platform == "android") and ((.namespace // .packageName // "") == $pkg)) | .appId' /tmp/fad-apps.json | head -n 1)"
          if [ -n "$EXPECTED_FIREBASE_APP_ID" ]; then
            echo "[firebase-ci] expected_firebase_app_id_for_${EXPECTED_ANDROID_PACKAGE}=$EXPECTED_FIREBASE_APP_ID"
          else
            echo "[firebase-ci] no Firebase Android app found for package '$EXPECTED_ANDROID_PACKAGE' in project '$FIREBASE_PROJECT_ID'."
          fi
          RESOLVED_FIREBASE_APP_ID="${FIREBASE_APP_ID}"
          if [ -n "$EXPECTED_FIREBASE_APP_ID" ] && [ "$FIREBASE_APP_ID" != "$EXPECTED_FIREBASE_APP_ID" ]; then
            echo "FIREBASE_APP_ID_ANDROID_DEV mismatch: expected '$EXPECTED_FIREBASE_APP_ID' for package '$EXPECTED_ANDROID_PACKAGE', got '$FIREBASE_APP_ID'. Overriding with expected app id for this workflow run." >&2
            RESOLVED_FIREBASE_APP_ID="$EXPECTED_FIREBASE_APP_ID"
          fi

          if ! npm_config_loglevel=error npx --yes firebase-tools@latest apps:sdkconfig ANDROID "$RESOLVED_FIREBASE_APP_ID" \
            --project "$FIREBASE_PROJECT_ID" \
            --out /tmp/fad-sdkconfig.json >/tmp/fad-sdkconfig.out 2>/tmp/fad-sdkconfig.err; then
            echo "Firebase app-id validation failed for FIREBASE_APP_ID_ANDROID_DEV='$RESOLVED_FIREBASE_APP_ID'." >&2
            cat /tmp/fad-sdkconfig.err >&2 || true
            echo "Get FIREBASE_APP_ID_ANDROID_DEV from Firebase Console > Project settings > Your apps > Android (com.edufelip.mapfriends.dev) > App ID." >&2
            if [ -n "${EXPECTED_FIREBASE_APP_ID:-}" ]; then
              echo "Expected App ID for package '$EXPECTED_ANDROID_PACKAGE' is '$EXPECTED_FIREBASE_APP_ID'." >&2
            fi
            exit 1
          fi
          APP_PACKAGE="$(jq -r --arg appid "$RESOLVED_FIREBASE_APP_ID" '
            .client[]?
            | select((.client_info.mobilesdk_app_id // "") == $appid)
            | (.client_info.android_client_info.package_name // empty)
          ' /tmp/fad-sdkconfig.json | head -n 1)"
          if [ -z "$APP_PACKAGE" ]; then
            echo "Unable to read Android package from sdkconfig for app id '$RESOLVED_FIREBASE_APP_ID'." >&2
            echo "sdkconfig clients (appId -> package):" >&2
            jq -r '.client[]? | "\(.client_info.mobilesdk_app_id // "n/a") -> \(.client_info.android_client_info.package_name // "n/a")"' /tmp/fad-sdkconfig.json >&2 || true
            exit 1
          fi

          if [ "$APP_PACKAGE" != "$EXPECTED_ANDROID_PACKAGE" ]; then
            echo "Firebase app id '$RESOLVED_FIREBASE_APP_ID' points to package '$APP_PACKAGE', expected '$EXPECTED_ANDROID_PACKAGE'." >&2
            echo "Update FIREBASE_APP_ID_ANDROID_DEV to the app id for package '$EXPECTED_ANDROID_PACKAGE'." >&2
            if [ -n "${EXPECTED_FIREBASE_APP_ID:-}" ]; then
              echo "Set FIREBASE_APP_ID_ANDROID_DEV to '$EXPECTED_FIREBASE_APP_ID'." >&2
            fi
            exit 1
          fi

          echo "firebase_app_id=$RESOLVED_FIREBASE_APP_ID" >> "$GITHUB_OUTPUT"
          echo "Firebase App Distribution preflight passed: auth ok, app id=$RESOLVED_FIREBASE_APP_ID, package=$APP_PACKAGE"
        working-directory: .

      - name: Resolve APK path
        id: resolve_apk
        run: |
          APK_PATH=$(find android/app/build/outputs/apk -type f -name "*debug*.apk" | sort | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "No debug APK found under android/app/build/outputs/apk" >&2
            exit 1
          fi
          echo "apk_path=$APK_PATH" >> "$GITHUB_OUTPUT"
        working-directory: .

      - name: Upload to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ steps.firebase_preflight.outputs.firebase_app_id }}
          serviceCredentialsFile: firebase-service-account.json
          groups: mapfriends
          file: ${{ steps.resolve_apk.outputs.apk_path }}
          releaseNotes: ${{ env.RELEASE_NOTES }}

      - name: Clean Firebase service account
        if: always()
        run: |
          rm -f firebase-service-account.json
        working-directory: .
